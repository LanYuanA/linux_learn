int major;  /*主设备号*/
int minor;  /*次设备号*/
dev_t devid;    /*设备号*/

if(major)
{
    devid = MKDEV(major,0);/*大部分驱动次设备号都选择0*/
    register_chrdev_region(devid,1,"test");/*申请设备号*/
}
else    /*没有设置设备号*/
{
    alloc_chrdev_region(&devid,0,1,"test");/*申请设备号*/
    major = MAJOR(devid);/*获得主设备号*/
    minor = MINOR(devid);/*获得次设备号*/
}

---

struct cdev 
{
    struct kobject kobj;
    struct module *owner;
    const struct file_operations *ops;
    struct list_head list;
    dev_t dev;
    unsigned int count;
};

struct cdev test_cdev;

void cdev_init(struct cdev *cdev, const struct file_operations *fops)

1 struct cdev testcdev;
2
3 /* 设备操作函数 */
4 static struct file_operations test_fops = {
5 .owner = THIS_MODULE,
6 /* 其他具体的初始项 */
7 };
8
9 testcdev.owner = THIS_MODULE;
10 cdev_init(&testcdev, &test_fops); /* 初始化 cdev 结构体变量 */